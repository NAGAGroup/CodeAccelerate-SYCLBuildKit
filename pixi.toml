# ============================================================================
# CodeAccelerate-SYCLBuildKit
# Build open-source, relocatable SYCL toolchains (Intel LLVM/DPC++) as conda packages
# ============================================================================

[workspace]
authors = ["Jack Myers <jackhyers97@gmail.com>"]
channels = ["conda-forge"]
name = "codeaccelerate-sycl"
platforms = ["linux-64"]
preview = ["pixi-build"]

[system-requirements]
libc = "2.34"

# ============================================================================
# Environment Variables
# ============================================================================

[activation.env]
PROJECT_ROOT = "$PIXI_PROJECT_ROOT"

# Default install prefix for local development
INSTALL_PREFIX = "$HOME/.local/naga-sycl-toolkit"

# LLVM source locations (populated by git submodule)
LLVM_SOURCE_DIR = "$PIXI_PROJECT_ROOT/packages/llvm/repo"
LLVM_BUILD_DIR = "$PIXI_PROJECT_ROOT/build/llvm"

# AdaptiveCpp source locations (populated by git submodule)
ADAPTIVECPP_SOURCE_DIR = "$PIXI_PROJECT_ROOT/packages/adaptivecpp/repo"
ADAPTIVECPP_BUILD_DIR = "$PIXI_PROJECT_ROOT/build/adaptivecpp"

# oneAPI library source locations
ONEMATH_SOURCE_DIR = "$PIXI_PROJECT_ROOT/packages/onemath/repo"
ONEMATH_BUILD_DIR = "$PIXI_PROJECT_ROOT/build/onemath"
ONEDPL_SOURCE_DIR = "$PIXI_PROJECT_ROOT/packages/onedpl/repo"
ONEDPL_BUILD_DIR = "$PIXI_PROJECT_ROOT/build/onedpl"

# SYCL implementation selection (default: dpcpp)
SYCL_IMPLEMENTATION = "dpcpp"

# ============================================================================
# Shared Features
# ============================================================================

# Core build tools required for all builds
[feature.build-tools.dependencies]
cmake = ">=3.24"
ninja = ">=1.12"
python = ">=3.10,<3.13"
git = ">=2.40"
ccache = ">=4.10"
pkg-config = ">=0.29"
pkgconfig = ">=1.5"
patchelf = ">=0.17"
wget = ">=1.21"
file = ">=5.39"

# Scripting with Nushell (like template-cpp-project)
[feature.build-tools.target.linux-64.dependencies]
nushell = ">=0.103"

# C/C++ compiler for building LLVM (host compiler)
[feature.host-compiler.target.linux-64.dependencies]
gcc_linux-64 = ">=12,<14"
gxx_linux-64 = ">=12,<14"
sysroot_linux-64 = ">=2.34"

# Linker
[feature.linker.target.linux-64.dependencies]
lld = ">=19"

# CUDA toolkit for NVIDIA backend
[feature.cuda.target.linux-64.dependencies]
cuda-toolkit = ">=12.6,<13"
cuda-nvcc = ">=12.6,<13"

# Host libraries needed for LLVM build
[feature.llvm-host-deps.target.linux-64.dependencies]
libxml2 = ">=2.12"
zlib = ">=1.3"
zstd-static = ">=1.5"
libhwloc = ">=2.11"
tbb-devel = ">=2021"
ocl-icd = ">=2.3"
libopencl-devel = ">=3.0"

# ============================================================================
# LLVM/DPC++ Build Feature
# ============================================================================

[feature.llvm]
platforms = ["linux-64"]

[feature.llvm.activation.env]
# Build configuration
LLVM_TARGETS = "X86;NVPTX;SPIRV"
SYCL_BACKENDS = "opencl;cuda;native_cpu"

[feature.llvm.activation]
scripts = ["activation/linux.sh", "activation/llvm.sh"]

[feature.llvm.target.linux-64.tasks]
# Submodule management
submodule-init = "git submodule update --init --recursive packages/llvm/repo"
submodule-update = "git submodule update --remote packages/llvm/repo"

# Build tasks (local development)
configure = { cmd = "nu scripts/llvm/configure.nu", depends-on = [
  "submodule-init",
] }
build = { cmd = "nu scripts/llvm/build.nu", depends-on = ["configure"] }
install = { cmd = "nu scripts/llvm/install.nu", depends-on = ["build"] }
test = { cmd = "nu scripts/llvm/test.nu", depends-on = ["install"] }

# Utility
clean = "rm -rf $LLVM_BUILD_DIR"
sycl-ls = { cmd = "$INSTALL_PREFIX/bin/sycl-ls", depends-on = ["install"] }

# ============================================================================
# AdaptiveCpp Build Feature
# ============================================================================

[feature.adaptivecpp]
platforms = ["linux-64"]

[feature.adaptivecpp.activation.env]
# Build configuration - generic compilation mode (JIT at runtime)
ACPP_TARGETS = "generic" # Generic JIT compilation (fast builds, runtime compilation)
# Backends enabled at build-time via CMake: CUDA (-DWITH_CUDA_BACKEND=ON), OpenMP (implicit)

[feature.adaptivecpp.activation]
scripts = ["activation/linux.sh", "activation/adaptivecpp.sh"]

# Clang compilers and LLVM dev tools - AdaptiveCpp builds against existing LLVM
# Use LLVM 19 to match Intel LLVM version and avoid compatibility issues
[feature.adaptivecpp.target.linux-64.dependencies]
clangxx_linux-64 = ">=19,<20"
clang_linux-64 = ">=19,<20"
llvmdev = ">=19,<20"                      # LLVM development files (CMake configs, headers, llvm-config)
clangdev = ">=19,<20"
boost-cpp = ">=1.84"                      # Required by AdaptiveCpp runtime
sysroot_linux-64 = ">=2.34"               # Provides standard C/C++ headers and libraries
libstdcxx-devel_linux-64 = ">=15.2,<15.3" # C++ standard library headers matching Clang's expectations

[feature.adaptivecpp.target.linux-64.tasks]
# Submodule management
submodule-init = "git submodule update --init --recursive packages/adaptivecpp/repo"
submodule-update = "git submodule update --remote packages/adaptivecpp/repo"

# Build tasks (local development)
configure = { cmd = "nu scripts/adaptivecpp/configure.nu", depends-on = [
  "submodule-init",
] }
build = { cmd = "nu scripts/adaptivecpp/build.nu", depends-on = ["configure"] }
install = { cmd = "nu scripts/adaptivecpp/install.nu", depends-on = ["build"] }
test = { cmd = "nu scripts/adaptivecpp/test.nu", depends-on = ["install"] }

# Utility
clean = "rm -rf $ADAPTIVECPP_BUILD_DIR"
acpp-info = { cmd = "$INSTALL_PREFIX/bin/acpp-info", depends-on = ["install"] }

# ============================================================================
# oneAPI Libraries Feature (oneMath + oneDPL)
# ============================================================================
# This feature provides environment setup for oneAPI libraries.
# Packages are installed via pixi dependencies, not manual build tasks.

[feature.oneapi]
platforms = ["linux-64"]

[feature.oneapi.activation.env]
# oneMath backends
ONEMATH_BLAS_BACKENDS = "cublas"
ONEMATH_LAPACK_BACKENDS = "cusolver"
ONEMATH_RNG_BACKENDS = "curand"
ONEMATH_DFT_BACKENDS = "cufft"
ONEMATH_SPARSE_BACKENDS = "cusparse"

# oneDPL backend
ONEDPL_BACKEND = "dpcpp"

# SYCL implementation (can be overridden)
SYCL_IMPLEMENTATION = "${SYCL_IMPLEMENTATION:-dpcpp}"

[feature.oneapi.activation]
scripts = ["activation/linux.sh", "activation/onemath.sh"]

# ============================================================================
# oneAPI with AdaptiveCpp Feature
# ============================================================================

[feature.oneapi-adaptivecpp-impl]
platforms = ["linux-64"]

[feature.oneapi-adaptivecpp-impl.activation.env]
SYCL_IMPLEMENTATION = "adaptivecpp"
DPCPP_ROOT = "$INSTALL_PREFIX"

[feature.oneapi-adaptivecpp-impl.activation]
scripts = ["activation/linux.sh", "activation/onemath.sh"]

# ============================================================================
# Development Environments
# ============================================================================

# Full development environment for LLVM + CUDA
[environments.dev]
features = [
  "build-tools",
  "host-compiler",
  "linker",
  "cuda",
  "llvm-host-deps",
  "llvm",
]

# LLVM-only development (no oneAPI libraries)
[environments.llvm]
features = [
  "build-tools",
  "host-compiler",
  "linker",
  "cuda",
  "llvm-host-deps",
  "llvm",
]

# AdaptiveCpp development (uses clang, not gcc)
[environments.adaptivecpp]
features = ["build-tools", "linker", "cuda", "llvm-host-deps", "adaptivecpp"]

# oneAPI libraries development - oneMath + oneDPL (requires pre-built DPC++)
[environments.oneapi]
features = ["build-tools", "cuda", "oneapi"]

# oneAPI libraries with AdaptiveCpp (requires pre-built AdaptiveCpp)
[environments.oneapi-adaptivecpp]
features = ["build-tools", "cuda", "oneapi-adaptivecpp-impl"]
solve-group = "oneapi-adaptivecpp"
