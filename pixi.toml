# ============================================================================
# CodeAccelerate-SYCLBuildKit
# Build open-source, relocatable SYCL toolchains (Intel LLVM/DPC++) as conda packages
# ============================================================================

[workspace]
authors = ["Jack Myers <jackhyers97@gmail.com>"]
channels = ["conda-forge"]
name = "codeaccelerate-sycl"
platforms = ["linux-64"]
preview = ["pixi-build"]

[system-requirements]
libc = "2.34"

# ============================================================================
# Environment Variables
# ============================================================================

[activation.env]
PROJECT_ROOT = "$PIXI_PROJECT_ROOT"

# Default install prefix for local development
INSTALL_PREFIX = "$HOME/.local/sycl-toolkit"

# LLVM source locations (populated by git submodule)
LLVM_SOURCE_DIR = "$PIXI_PROJECT_ROOT/packages/llvm/repo"
LLVM_BUILD_DIR = "$PIXI_PROJECT_ROOT/build/llvm"

# oneMath source locations
ONEMATH_SOURCE_DIR = "$PIXI_PROJECT_ROOT/packages/onemath/repo"
ONEMATH_BUILD_DIR = "$PIXI_PROJECT_ROOT/build/onemath"

# ============================================================================
# Shared Features
# ============================================================================

# Core build tools required for all builds
[feature.build-tools.dependencies]
cmake = ">=3.24"
ninja = ">=1.12"
python = ">=3.10,<3.13"
git = ">=2.40"
ccache = ">=4.10"
pkg-config = ">=0.29"
pkgconfig = ">=1.5"
patchelf = ">=0.17"
wget = ">=1.21"
file = ">=5.39"

# Scripting with Nushell (like template-cpp-project)
[feature.build-tools.target.linux-64.dependencies]
nushell = ">=0.103"

# C/C++ compiler for building LLVM (host compiler)
[feature.host-compiler.target.linux-64.dependencies]
gcc_linux-64 = ">=12,<14"
gxx_linux-64 = ">=12,<14"
sysroot_linux-64 = ">=2.34"

# Linker
[feature.linker.target.linux-64.dependencies]
lld = ">=19"

# CUDA toolkit for NVIDIA backend
[feature.cuda.target.linux-64.dependencies]
cuda-toolkit = ">=12.6,<13"
cuda-nvcc = ">=12.6,<13"

# Host libraries needed for LLVM build
[feature.llvm-host-deps.target.linux-64.dependencies]
libxml2 = ">=2.12"
zlib = ">=1.3"
zstd-static = ">=1.5"
libhwloc = ">=2.11"
tbb-devel = ">=2021"
ocl-icd = ">=2.3"
libopencl-devel = ">=3.0"

# ============================================================================
# LLVM/DPC++ Build Feature
# ============================================================================

[feature.llvm]
platforms = ["linux-64"]

[feature.llvm.activation.env]
# Build configuration
LLVM_TARGETS = "X86;NVPTX;SPIRV"
SYCL_BACKENDS = "opencl;cuda;native_cpu"

[feature.llvm.activation]
scripts = ["activation/linux.sh", "activation/llvm.sh"]

[feature.llvm.target.linux-64.tasks]
# Submodule management
submodule-init = "git submodule update --init --recursive packages/llvm/repo"
submodule-update = "git submodule update --remote packages/llvm/repo"

# Build tasks (local development)
configure = { cmd = "nu scripts/llvm/configure.nu", depends-on = ["submodule-init"] }
build = { cmd = "nu scripts/llvm/build.nu", depends-on = ["configure"] }
install = { cmd = "nu scripts/llvm/install.nu", depends-on = ["build"] }
test = { cmd = "nu scripts/llvm/test.nu", depends-on = ["install"] }

# Utility
clean = "rm -rf $LLVM_BUILD_DIR"
sycl-ls = { cmd = "$INSTALL_PREFIX/bin/sycl-ls", depends-on = ["install"] }

# ============================================================================
# oneMath Build Feature
# ============================================================================

[feature.onemath]
platforms = ["linux-64"]

[feature.onemath.activation.env]
# oneMath backends to enable
ONEMATH_BLAS_BACKENDS = "cublas"
ONEMATH_LAPACK_BACKENDS = "cusolver"
ONEMATH_RNG_BACKENDS = "curand"
ONEMATH_DFT_BACKENDS = "cufft"
ONEMATH_SPARSE_BACKENDS = "cusparse"

[feature.onemath.activation]
scripts = ["activation/linux.sh", "activation/onemath.sh"]

[feature.onemath.target.linux-64.tasks]
submodule-init = "git submodule update --init --recursive packages/onemath/repo"
configure = { cmd = "nu scripts/onemath/configure.nu", depends-on = ["submodule-init"] }
build = { cmd = "nu scripts/onemath/build.nu", depends-on = ["configure"] }
install = { cmd = "nu scripts/onemath/install.nu", depends-on = ["build"] }

# ============================================================================
# Development Environments
# ============================================================================

# Full development environment for LLVM + CUDA
[environments.dev]
features = ["build-tools", "host-compiler", "linker", "cuda", "llvm-host-deps", "llvm"]

# LLVM-only development (no oneMath)
[environments.llvm]
features = ["build-tools", "host-compiler", "linker", "cuda", "llvm-host-deps", "llvm"]

# oneMath development (requires pre-built DPC++)
[environments.onemath]
features = ["build-tools", "cuda", "onemath"]
