# naga-onemath Workspace
# SYCL math library with NVIDIA CUDA backend support
#
# ============================================================================
# WORKFLOW
# ============================================================================
#
# First time setup (creates recipe symlinks):
#   pixi run -e init setup
#
# Initialize submodule:
#   pixi run -e init submodule-init
#
# Build and install:
#   pixi install
#
# This builds three packages from one recipe:
#   - naga-onemath-libs:  Runtime libraries only
#   - naga-onemath-devel: Development files (headers, cmake modules)
#   - naga-onemath:       Full package (meta-package)
#
# ============================================================================
# BUILD STRATEGY
# ============================================================================
#
# The build runs directly in the repo/ directory (not a copy) to enable
# incremental builds. Subsequent builds only recompile changed files.
#
# IMPORTANT: The naga-sycl-toolkit package must be built first from packages/llvm/
# The local channel is included to provide the naga-sycl-toolkit packages during build.
#
# ============================================================================

[workspace]
channels = [
  # Local channel with naga-sycl-toolkit packages (built from packages/llvm/)
  "https://prefix.dev/code-accelerate",
  # Pixi build backends
  "https://prefix.dev/pixi-build-backends",
  # Main conda-forge channel
  "conda-forge",
]
platforms = ["linux-64"]
preview = ["pixi-build"]

[package.build]
backend = { name = "pixi-build-rattler-build", version = "*", channels = [
  "https://prefix.dev/code-accelerate",
  "https://prefix.dev/conda-forge",
] }

[system-requirements]
libc = "2.34"

# Install the full naga-onemath package (which depends on devel -> libs)
[target.linux-64.dependencies]
naga-adaptivecpp-toolkit = ">=2026.2.14,<2027"

# ============================================================================
# Init environment (no default feature - doesn't trigger package builds)
# ============================================================================
# This environment is used to set up recipe symlinks before the first build.
# The symlinks are a workaround until pixi-build-rattler-build supports
# custom recipe paths. See: https://github.com/prefix-dev/pixi-build-backends/issues/471

[feature.init]
platforms = ["linux-64"]

[feature.init.tasks]
setup = """
ln -sfn ../recipe libs/recipe && \
ln -sfn ../recipe devel/recipe && \
ln -sfn ../recipe onemath/recipe && \
echo "Recipe symlinks created successfully"
"""

submodule-init = """
cd ../.. && git submodule update --init packages/onemath/repo
"""

[environments]
init = { features = ["init"], no-default-feature = true }
