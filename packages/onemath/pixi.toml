# oneMath Workspace
# SYCL math library with NVIDIA CUDA backend support
#
# ============================================================================
# WORKFLOW
# ============================================================================
#
# First time setup (creates recipe symlinks):
#   pixi run -e init setup
#
# Initialize submodule:
#   pixi run -e init submodule-init
#
# Build and install:
#   pixi install
#
# This builds three packages from one recipe:
#   - onemath-libs:  Runtime libraries only
#   - onemath-devel: Development files (headers, cmake modules)
#   - onemath:       Full package (meta-package)
#
# ============================================================================
# BUILD STRATEGY
# ============================================================================
#
# The build runs directly in the repo/ directory (not a copy) to enable
# incremental builds. Subsequent builds only recompile changed files.
#
# IMPORTANT: The sycl-toolkit package must be built first from packages/llvm/
# The local channel (../llvm/output) is included to provide the sycl-toolkit
# packages during the build.
#
# ============================================================================

[workspace]
channels = [
    # Local channel with sycl-toolkit packages (built from packages/llvm/)
    { path = "../llvm/output" },
    # Pixi build backends
    "https://prefix.dev/pixi-build-backends",
    # Main conda-forge channel
    "conda-forge"
]
platforms = ["linux-64"]
preview = ["pixi-build"]

[system-requirements]
libc = "2.34"

# Install the full onemath package (which depends on devel -> libs)
[dependencies]
onemath = { path = "onemath" }

# ============================================================================
# Init environment (no default feature - doesn't trigger package builds)
# ============================================================================
# This environment is used to set up recipe symlinks before the first build.
# The symlinks are a workaround until pixi-build-rattler-build supports
# custom recipe paths. See: https://github.com/prefix-dev/pixi-build-backends/issues/471

[feature.init]
platforms = ["linux-64"]

[feature.init.tasks]
setup = """
ln -sfn ../recipe libs/recipe && \
ln -sfn ../recipe devel/recipe && \
ln -sfn ../recipe onemath/recipe && \
echo "Recipe symlinks created successfully"
"""

submodule-init = """
cd ../.. && git submodule update --init packages/onemath/repo
"""

[environments]
init = { features = ["init"], no-default-feature = true }
